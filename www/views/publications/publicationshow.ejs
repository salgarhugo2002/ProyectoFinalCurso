<%- include("../templates/cabecera") %>



  <style>
    div.row {
      text-align: center;


    }

    td {
      color: white;
    }

    th {
      color: white;
    }
  </style>
  </head>

  <body onload="main()">
    <%- include("../templates/menu") %>


      <% if (user !=undefined && user.type=="user" ) { %>

        <div class="container text-white text-center border" style="max-width: 500px; margin-top: 10px;">

          <div class="mx-auto">
            <h3 class="text-center my-3">Información de la publicación</h3>
            <div class=""><strong>Titulo:</strong></div>
            <div class="" id="titulo"></div>
            <div class=""><strong>Empresa:</strong></div>
            <div class="" id="empresa"></div>
            <div class=""><strong>Estudios:</strong></div>
            <div class="" id="estudios"></div>
            <div class=""><strong>Tipo de convenio:</strong></div>
            <div class="" id="convenio"></div>
            <div class=""><strong>Municipio:</strong></div>
            <div class="" id="municipio"></div>
            <div class=""><strong>Dirección:</strong></div>
            <div class="" id="direccion"></div>
            <div class=""><strong>Descripción del puesto:</strong></div>
            <div class=" text-break" id="desc"></div>
            <div class=""><strong>Caduca:</strong></div>
            <div class="" id="caduca"></div>
          </div>

          <div class="d-flex justify-content-center mt-3">
            <button class="btn btn-success" onclick="inscribeme('<%= user._id %>')">Inscribeme</button>
          </div>

        </div>
        <% } else if (user !=undefined && user.type=="company" ) { %>

          <div class="container text-white text-center border" style="max-width: 500px; margin-top: 10px;">

            <div class="mx-auto">
              <h3 class="text-center my-3">Información de la publicación</h3>
              <div class=""><strong>Titulo:</strong></div>
              <div class="" id="titulo"></div>

              <div class=""><strong>Empresa:</strong></div>
              <div class="" id="empresa"></div>
              <div class=""><strong>Estudios:</strong></div>
              <div class="" id="estudios"></div>
              <div class=""><strong>Tipo de convenio:</strong></div>
              <div class="" id="convenio"></div>
              <div class=""><strong>Municipio:</strong></div>
              <div class="" id="municipio"></div>
              <div class=""><strong>Dirección:</strong></div>
              <div class="" id="direccion"></div>
              <div class=""><strong>Descripción del puesto:</strong></div>
              <div class=" text-break" id="desc"></div>
              <div class=""><strong>Caduca:</strong></div>
              <div class="" id="caduca"></div>
            </div>


            <div class="d-flex justify-content-center mt-3" id="botoncito">

            </div>
          </div>
          <% } %>


            <div class="d-flex" id="users" style="align-items: center; justify-content: center;"></div>

  </body>


  <script>
    const publi = JSON.parse('<%- publi %>')

    let users = []

    let usuari = []
    async function main() {
      document.getElementById('users').innerHTML = "";
      usuari = await retUsers()
      const empr = await retEmpresa(publi.companyId)



      document.getElementById('titulo').innerHTML = publi.titulo;

      document.getElementById('estudios').innerHTML = publi.filtroEstudios

      document.getElementById('municipio').innerHTML = publi.filtroMunicipio

      document.getElementById('empresa').innerHTML = empr.name

      document.getElementById('direccion').innerHTML = empr.calle + " " + empr.numeroCalle

      document.getElementById('convenio').innerHTML = publi.tipo

      document.getElementById('desc').innerHTML = publi.texto

      document.getElementById('caduca').innerHTML = publi.caducidad

      function mostrar() {

      }
      if (publi.companyId == "<%= user._id %>") {
        const form = document.createElement("form")
        form.action = "/deletepublication/" + publi._id
        form.method = "POST"

        const btn = document.createElement("input")
        btn.className = "btn btn-danger"
        btn.textContent = "ELiminar"
        btn.type = "submit"
        btn.value = "Eliminar"

        document.getElementById('botoncito').appendChild(form)
        form.appendChild(btn)


        let table = document.createElement('table')
        table.className = "table"
        table.style = "width: 80%"
        let thead = document.createElement('thead')
        let tr = document.createElement('tr')
        tr.innerHTML = "<th> <strong> Nombre </strong> </th> <th> <strong> Correo </strong></th> <th> </th>  <th> </th> <th>Acciones </th>"
        thead.appendChild(tr)
        table.appendChild(thead)

        let tbody = document.createElement('tbody');
        table.appendChild(tbody)

        let inscripts = await retInscript();

        let aux = []
        inscripts.forEach(element => {
          if (element.publicationId == publi.id) {
            aux.push(element);

          }

        })


        usuari.forEach(element => {
          aux.forEach(element2 => {
            if (element._id == element2.userId) {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = element.username;
                row.appendChild(nameCell);

                const emailCell = document.createElement('td');
                emailCell.textContent = element.email;
                row.appendChild(emailCell);

                const ageCell = document.createElement('td');
                row.appendChild(ageCell);


                const Cell = document.createElement('td');
                row.appendChild(Cell);


                const actionCell = document.createElement('td');
                const butn = document.createElement('button')
                butn.className = "btn btn-success"
                butn.innerHTML = "Aceptar"
                butn.style.marginRight = "3px"
                butn.onclick = "aceptar()"
                actionCell.appendChild(butn)


                let form = document.createElement('form')
                form.action ="/inscriptions/delete/" + element2._id + "/" + publi.id
                form.method="post"

                const butn2 = document.createElement('button')
                butn2.className = "btn btn-danger"
                butn2.innerHTML = "Rechazar"
                butn2.type = "submit"
                form.appendChild(butn2)

                actionCell.appendChild(form)

                row.appendChild(actionCell);


                tbody.appendChild(row);



            }

          });

        });



        document.getElementById('users').appendChild(table)
      }
    }


    async function retEmpresa(id) {
      const response = await fetch('http://localhost:3000/company/show/' + id);
      const data = await response.json();
      return data;
    }

    async function retUsers() {
      const response = await fetch('http://localhost:3000/users');
      const data = await response.json();
      return data;
    }

    async function retInscript() {
      const response = await fetch('http://localhost:3000/inscriptions');
      const data = await response.json();
      return data;
    }


    async function inscribeme(idUser) {


      let object = { "publicationId": publi.id, "userId": idUser }

      let jsonString = JSON.stringify(object)


      fetch('http://localhost:3000/inscription/create',
        {
          method: "POST",
          body: jsonString,
          headers: {
            'Content-Type': 'application/json'
          }
        })


      alert("Se ha inscrito correctamente")
    }



  </script>