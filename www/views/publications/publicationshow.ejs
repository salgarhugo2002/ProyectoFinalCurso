<%- include("../templates/cabecera") %>



  <style>
    div.row {
      text-align: center;


    }

    td {
      color: white;
    }

    th {
      color: white;
    }
  </style>
  </head>

  <body onload="main()">
    <%- include("../templates/menu") %>


      <% if (user !=undefined && user.type=="user" ) { %>

        <div class="container text-white text-center border" style="max-width: 500px; margin-top: 10px;">

          <div class="mx-auto">
            <h3 class="text-center my-3">Información de la publicación</h3>
            <div class=""><strong>Titulo:</strong></div>
            <div class="" id="titulo"></div>
            <div class=""><strong>Empresa:</strong></div>
            <div class="" id="empresa"></div>
            <div class=""><strong>Estudios:</strong></div>
            <div class="" id="estudios"></div>
            <div class=""><strong>Tipo de convenio:</strong></div>
            <div class="" id="convenio"></div>
            <div class=""><strong>Municipio:</strong></div>
            <div class="" id="municipio"></div>
            <div class=""><strong>Dirección:</strong></div>
            <div class="" id="direccion"></div>
            <div class=""><strong>Descripción del puesto:</strong></div>
            <div class=" text-break" id="desc"></div>
            <div class=""><strong>Caduca:</strong></div>
            <div class="" id="caduca"></div>
          </div>

          <div id="inscr" class="d-flex justify-content-center mt-3">

          </div>

        </div>
        <% } else if (user !=undefined && user.type=="company" ) { %>

          <div class="container text-white text-center border" style="max-width: 500px; margin-top: 10px;">

            <div class="mx-auto">
              <h3 class="text-center my-3">Información de la publicación</h3>
              <div class=""><strong>Titulo:</strong></div>
              <div class="" id="titulo"></div>

              <div class=""><strong>Empresa:</strong></div>
              <div class="" id="empresa"></div>
              <div class=""><strong>Estudios:</strong></div>
              <div class="" id="estudios"></div>
              <div class=""><strong>Tipo de convenio:</strong></div>
              <div class="" id="convenio"></div>
              <div class=""><strong>Municipio:</strong></div>
              <div class="" id="municipio"></div>
              <div class=""><strong>Dirección:</strong></div>
              <div class="" id="direccion"></div>
              <div class=""><strong>Descripción del puesto:</strong></div>
              <div class=" text-break" id="desc"></div>
              <div class=""><strong>Caduca:</strong></div>
              <div class="" id="caduca"></div>
            </div>
            
            <div id="inscr" class="d-flex justify-content-center mt-3">

            </div>
            
            <div class="d-flex justify-content-center mt-3" id="botoncito">
              
            </div>
          </div>
          <% } %>
          
            <span class="container text-center" id="texto"></span>
            <div class="d-flex" id="users" style="align-items: center; justify-content: center;"></div>

  </body>


  <script>
    const publi = JSON.parse('<%- publi %>')

    let users = []

    let usuari = []
    async function main() {
      let inscripts = await retInscript();
      document.getElementById('users').innerHTML = "";
      usuari = await retUsers()
      const empr = await retEmpresa(publi.companyId)



      document.getElementById('titulo').innerHTML = publi.titulo;

      document.getElementById('estudios').innerHTML = publi.filtroEstudios

      document.getElementById('municipio').innerHTML = publi.filtroMunicipio

      document.getElementById('empresa').innerHTML = empr.name

      document.getElementById('direccion').innerHTML = empr.calle + " " + empr.numeroCalle

      document.getElementById('convenio').innerHTML = publi.tipo

      document.getElementById('desc').innerHTML = publi.texto

      document.getElementById('caduca').innerHTML = publi.caducidad

      function mostrar() {


      }
      let bol = false;
      inscripts.forEach(element => {

        if(element.publicationId == publi._id){
          if (element.userId == "<%= user._id %>" ){
            bol = true;
          }
        }
        

      });

      if (bol) {
       
        let ap = document.createElement('p')
        ap.style.color = "red"
        ap.innerHTML = "<strong> Ya estás inscrito </strong>"
        document.querySelector('#inscr').appendChild(ap)
      } else if ('true' == '<%= user.type != "company" %>') {
        const boton = document.createElement('button')
        boton.className = "btn btn-success"
        boton.innerHTML = "Inscribeme"
        boton.addEventListener("click", function () {
          inscribeme('<%= user._id %>');
        });

        document.querySelector('#inscr').appendChild(boton)
      } else {

        if (publi.companyId == "<%= user._id %>") {
          const form = document.createElement("form")
          form.action = "/deletepublication/" + publi._id
          form.method = "POST"

          const text = document.createElement("h2")
          text.innerHTML = "Inscritos"
          text.style.color = "white"
          document.getElementById("texto").appendChild(text)
          const btn = document.createElement("input")
          btn.className = "btn btn-danger"
          btn.textContent = "ELiminar"
          btn.type = "submit"
          btn.value = "Eliminar"

          btn.style.marginBottom = '5px'
          document.getElementById('botoncito').appendChild(form)
          form.appendChild(btn)

          

          let table = document.createElement('table')
          table.className = "table"
          
          let thead = document.createElement('thead')
          let tr = document.createElement('tr')
          tr.innerHTML = "<th> <strong> Nombre </strong> </th> <th> <strong> Correo </strong></th> <th> </th>  <th> </th> <th>Acciones </th>"
          thead.appendChild(tr)
          table.appendChild(thead)

          let tbody = document.createElement('tbody');
          table.appendChild(tbody)



          let aux = []
          inscripts.forEach(element => {
            if (element.publicationId == publi._id) {
              aux.push(element);

            }

          })


          usuari.forEach(element => {
            aux.forEach(element2 => {
              if (element._id == element2.userId) {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = element.username;
                row.appendChild(nameCell);

                const emailCell = document.createElement('td');
                emailCell.textContent = element.email;
                row.appendChild(emailCell);

                const ageCell = document.createElement('td');
                row.appendChild(ageCell);


                const Cell = document.createElement('td');
                row.appendChild(Cell);


                const actionCell = document.createElement('td');

                let form = document.createElement('form')
                form.action = "/inscriptions/delete/" + element2._id + "/" + publi._id
                form.method = "post"

                

                const butn3 = document.createElement('a')
                butn3.className = "btn btn-info"
                butn3.innerHTML = "Ver perfil"
                butn3.href = "/profile/"+ element2.userId

                const butn2 = document.createElement('button')
                butn2.className = "btn btn-danger"
                butn2.innerHTML = "Rechazar"
                butn2.type = "submit"
                form.appendChild(butn2)
                form.appendChild(butn3)
                actionCell.appendChild(form)

                row.appendChild(actionCell);


                tbody.appendChild(row);



              }

            });

          });



          document.getElementById('users').appendChild(table)
        }

      }

    }
    async function retEmpresa(id) {
      const response = await fetch('http://localhost:3000/company/show/' + id);
      const data = await response.json();
      return data;
    }

    async function retUsers() {
      const response = await fetch('http://localhost:3000/users');
      const data = await response.json();
      return data;
    }

    async function retInscript() {
      const response = await fetch('http://localhost:3000/inscriptions');
      const data = await response.json();
      return data;
    }


    async function inscribeme(idUser) {


      let object = { "publicationId": publi._id, "userId": idUser }

      let jsonString = JSON.stringify(object)


      fetch('http://localhost:3000/inscription/create',
        {
          method: "POST",
          body: jsonString,
          headers: {
            'Content-Type': 'application/json'
          }
        })


      alert("Se ha inscrito correctamente")
    }





  </script>